# 开发规范

## 模块分层

### API层(包含Router)


- server/apps/ansible/api/adhoc.py

```python
from fastapi import Body
from fastapi_utils.cbv import cbv
from fastapi_utils.inferring_router import InferringRouter

from core.http_schemas.common_response_schema import CommonResponseSchema
from server.apps.ansible.forms.adhoc import ADHocModel
from server.apps.ansible.services.adhoc import AnsibleAdHocService

adhoc_api = InferringRouter()


@cbv(adhoc_api)
class AdHocAPI:
    @adhoc_api.post("/fast_execute_adhoc", response_model=CommonResponseSchema, name="Ansible快速执行Adhoc命令")
    async def fast_execute_adhoc(
            self,
            data: ADHocModel = Body(
                None,
                description="Ansible执行Adhoc命令",
                example={
                    "module": "uptime",
                    "module_args": "",
                    "extra_vars":{},
                    "credential_id": "/host/xx",
                    "is_async": False,
                    "timeout": 10,
                },
            ),
    ) -> CommonResponseSchema:
        result = AnsibleAdHocService(data)()
        return CommonResponseSchema(data=result, message="操作成功", success=True)

```

- server/apps/ansible/url.py

```python
from fastapi_utils.inferring_router import InferringRouter

from server.apps.ansible.api.adhoc import adhoc_api
from server.apps.ansible.api.playbook import playbook_api

ansible_api = InferringRouter()
ansible_api.include_router(adhoc_api, prefix="/ansible/v1", tags=["Ansible"])
ansible_api.include_router(playbook_api, prefix="/ansible/v1", tags=["Ansible"])

```

### Form层

- server/apps/ansible/forms/adhoc.py

```python
import typing

from pydantic import BaseModel, Field


class ADHocModel(BaseModel):
    module: str = Field("", description="模块名")
    module_args: str = Field("", description="模块参数")
    is_async: bool = Field(False, description="是否异步请求,默认同步")
    credential_id: str = Field("", description="凭据标识")
    timeout: typing.Union[None, int] = Field(None, description="超时时间,默认无")

```

### Service层

- server/apps/ansible/services/adhoc.py

```python
from core.driver.ansible.credential import get_outputs_by_path
from core.driver.ansible.form.adhoc_result import AdHocResult
from core.logger import logger
from core.service import DriverService, pre_run
from server.apps.ansible.forms.adhoc import ADHocModel


class AnsibleAdHocService(DriverService):
    __driver_tag__ = "ansible"
    driver_run_fn = "run_local_adhoc"
    input_model = ADHocModel
    output_model = AdHocResult

    @pre_run
    def build_credential_args(self):
        if self.input.credential_id:
            credential_args = get_outputs_by_path(self.input.module, self.input.credential_id)
            self.input.module_args += " " + credential_args
        logger.info(f"input:{self.input.dict()}")

    def _run(self):
        self.output = self.driver.run_local_adhoc(
            module_name=self.input.module,
            module_args=self.input.module_args,
            extravars = self.input.extra_vars,
            is_async=self.input.is_async,
            timeout=self.input.timeout,
        )


```

### Entity层

> 当前未使用DB,暂无

### Task层

- server/apps/ansible/tasks/adhoc.py

```python
from core import celery_app as celery


@celery.task(name="example_task")
def example_task(m, n):
    return m + n
```

### Driver层

- server/driver/ansible/ansible_driver.py

```python

from core import Driver


class AnsibleDriver(Driver):
    __tag__ = "ansible"

    def run(self):
        pass
```



